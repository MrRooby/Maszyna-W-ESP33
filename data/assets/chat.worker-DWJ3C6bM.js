(function(){"use strict";const g={BASE_URL:"/",DEV:!1,MODE:"esp",PROD:!0,SSR:!1,VITE_API_URL:"https://maszynaw.groupmta.com/api/chat",VITE_APP_PLATFORM:"esp"};function m(e){return e?typeof e.response=="string"?e.response:typeof e.text=="string"?e.text:e.data&&typeof e.data.text=="string"?e.data.text:Array.isArray(e)&&typeof e[0]=="string"?e[0]:"":""}const d=(()=>{const e=typeof{url:self.location.href}<"u"&&g&&"https://maszynaw.groupmta.com/api/chat"||"";if(e)return e;const t=typeof self<"u"&&self.location?self.location:{protocol:"http:",hostname:"localhost"},{protocol:o,hostname:r}=t,c=/^(\d{1,3}\.){3}\d{1,3}$/.test(r);return r==="localhost"||c?`${o}//${r}:8787/api/chat`:"/api/chat"})(),p=d.replace(/\/api\/chat\/?$/,"/health"),l=new Map,w=e=>new Promise(t=>setTimeout(t,e));async function h(e,t={},o=15e3){const r=new AbortController,c=setTimeout(()=>r.abort(),o);try{const n=await fetch(e,{...t,signal:r.signal}),s=n.headers.get("content-type")||"";let a=null;if(s.includes("application/json"))a=await n.json().catch(()=>({}));else{const i=await n.text().catch(()=>"");try{a=JSON.parse(i)}catch{a={text:i}}}return{ok:n.ok,status:n.status,body:a,headers:n.headers}}finally{clearTimeout(c)}}function u(e,t){self.postMessage({messageId:e,...t})}async function y(e,t){const{query:o,history:r,sessionId:c}=e,n=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json",...c?{"X-Session-Id":c}:{}},body:JSON.stringify({query:o,history:r}),signal:t.signal});if(!n.ok){const a=await n.text().catch(()=>"");throw new Error(`HTTP ${n.status} ${n.statusText}${a?` - ${a}`:""}`)}let s=null;try{s=await n.json()}catch{s={response:await n.text()}}return m(s)||"[AI did not return a response]"}async function T(e){const{messageId:t,query:o,history:r,sessionId:c}=e;if(!t||typeof t!="string")return;if(typeof o!="string"||!Array.isArray(r)){u(t,{error:"Invalid payload (query/history).",done:!0});return}const n=l.get(t);n&&(n.cancelled=!0,n.controller.abort(),l.delete(t));const s=new AbortController,a={controller:s,cancelled:!1};l.set(t,a);try{let i=null;try{i=await y({query:o,history:r,sessionId:c},s)}catch(f){if(s.signal.aborted||(await h(`${p}?check=1`,{method:"GET"},8e3).catch(()=>null),await h(`${p}?wake=1`,{method:"GET"},25e3).catch(()=>null),s.signal.aborted))throw f;await w(1500),i=await y({query:o,history:r,sessionId:c},s)}if(s.signal.aborted||a.cancelled){u(t,{cancelled:!0,done:!0});return}u(t,{text:i,done:!0})}catch(i){if(s.signal.aborted||a.cancelled){u(t,{cancelled:!0,done:!0});return}const f=`Nie udało się pobrać odpowiedzi od AI. ${(i==null?void 0:i.message)||""}`.trim();u(t,{error:f,done:!0})}finally{l.delete(t)}}function x(e){const{messageId:t}=e||{};if(!t||typeof t!="string")return;const o=l.get(t);o&&(o.cancelled=!0,o.controller.abort())}self.addEventListener("message",e=>{const t=e.data;if(t){if(t.type==="cancel"){x(t);return}t.type==="start"&&T(t).catch(o=>{console.error("Worker start handler failed",o)})}})})();
